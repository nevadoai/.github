name: IaC Security & Vulnerability Scan (Reusable)

# Reusable workflow for Infrastructure as Code security and vulnerability scanning
# Supports Terraform, CloudFormation, and other IaC formats
#
# Features:
# - checkov: Multi-cloud IaC security scanner (Terraform, CloudFormation, etc.)
# - trivy: Comprehensive IaC vulnerability scanner
# - cfn-lint: CloudFormation linting and validation
#
# Usage in your repo:
# Create .github/workflows/security-scan.yml:
#
# IMPORTANT: Use version tags (@v1.0.0) or commit SHAs, never @main
#
# name: Security Scan
# on: [push, pull_request]
# permissions:
#   contents: read
#   pull-requests: write  # Required for PR comments
# jobs:
#   iac-scan:
#     uses: nevadoai/.github/.github/workflows/iac-security-scan.yml@v1.0.0
#     with:
#       working-directory: './terraform'  # Optional

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for IaC files'
        required: false
        type: string
        default: '.'
      terraform-directory:
        description: 'Directory containing Terraform files (if different from working-directory)'
        required: false
        type: string
        default: ''
      cloudformation-directory:
        description: 'Directory containing CloudFormation templates (if different from working-directory)'
        required: false
        type: string
        default: ''
      severity:
        description: 'Minimum severity level to report (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: string
        default: 'MEDIUM'
      skip-checkov:
        description: 'Skip checkov scanning'
        required: false
        type: boolean
        default: false
      skip-cfn-lint:
        description: 'Skip CloudFormation linting'
        required: false
        type: boolean
        default: false

jobs:
  checkov:
    name: Checkov - Multi-Cloud IaC Scanner
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-checkov }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        id: checkov
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: |
          # Run Checkov and capture output
          checkov --directory . \
            --output cli \
            --soft-fail \
            --compact \
            --framework terraform cloudformation arm kubernetes helm dockerfile secrets \
            > checkov_output.txt 2>&1 || true

          # Check if there are any findings
          if grep -q "Passed checks:" checkov_output.txt; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Checkov results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: ${{ inputs.working-directory }}/checkov_output.txt

      - name: Find Pull Request
        if: always() && steps.checkov.outputs.has_results == 'true'
        uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - name: Comment PR with Checkov Results
        if: always() && steps.findPr.outputs.pr != '' && steps.checkov.outputs.has_results == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const checkovOutput = fs.readFileSync('${{ inputs.working-directory }}/checkov_output.txt', 'utf8');

            // Truncate if too long (GitHub comment limit is ~65k characters)
            let output = checkovOutput;
            if (output.length > 60000) {
              output = output.substring(0, 60000) + '\n\n... (output truncated)';
            }

            const body = `## Checkov Security Scan Results

            <details><summary>View Checkov Findings</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            **Commit:** ${{ github.sha }}`;

            github.rest.issues.createComment({
              issue_number: ${{ steps.findPr.outputs.pr }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  trivy-iac:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy IaC scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: ${{ inputs.working-directory }}
          format: 'table'
          severity: ${{ inputs.severity }}
          scanners: 'config,secret'
          exit-code: '0'

      - name: Capture Trivy output
        id: trivy-output
        run: |
          # Re-run Trivy to capture output to file
          trivy config ${{ inputs.working-directory }} \
            --format table \
            --severity ${{ inputs.severity }} \
            --scanners config,secret \
            > trivy_output.txt 2>&1 || true

          if [ -s trivy_output.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy_output.txt

      - name: Find Pull Request
        if: always() && steps.trivy-output.outputs.has_results == 'true'
        uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - name: Comment PR with Trivy Results
        if: always() && steps.findPr.outputs.pr != '' && steps.trivy-output.outputs.has_results == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const trivyOutput = fs.readFileSync('trivy_output.txt', 'utf8');

            // Truncate if too long
            let output = trivyOutput;
            if (output.length > 60000) {
              output = output.substring(0, 60000) + '\n\n... (output truncated)';
            }

            const body = `## Trivy IaC Security Scan Results

            <details><summary>View Trivy Findings</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            **Commit:** ${{ github.sha }}`;

            github.rest.issues.createComment({
              issue_number: ${{ steps.findPr.outputs.pr }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  cfn-lint:
    name: CloudFormation Linter
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-cfn-lint }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: Determine CloudFormation directory
        id: cfn-dir
        run: |
          if [ -n "${{ inputs.cloudformation-directory }}" ]; then
            echo "dir=${{ inputs.cloudformation-directory }}" >> $GITHUB_OUTPUT
          else
            echo "dir=${{ inputs.working-directory }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for CloudFormation templates
        id: check-cfn
        run: |
          if find "${{ steps.cfn-dir.outputs.dir }}" -type f \( -name "*.template" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" \) | grep -q .; then
            echo "has_templates=true" >> $GITHUB_OUTPUT
          else
            echo "has_templates=false" >> $GITHUB_OUTPUT
          fi

      - name: Run cfn-lint
        id: cfn-lint
        if: steps.check-cfn.outputs.has_templates == 'true'
        working-directory: ${{ steps.cfn-dir.outputs.dir }}
        continue-on-error: true
        run: |
          cfn-lint **/*.template **/*.yaml **/*.yml **/*.json > cfn-lint-results.txt 2>&1 || true

          if [ -s cfn-lint-results.txt ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload cfn-lint results
        if: steps.check-cfn.outputs.has_templates == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: cfn-lint-results
          path: ${{ steps.cfn-dir.outputs.dir }}/cfn-lint-results.txt

      - name: Find Pull Request
        if: always() && steps.check-cfn.outputs.has_templates == 'true' && steps.cfn-lint.outputs.has_results == 'true'
        uses: jwalton/gh-find-current-pr@v1
        id: findPr

      - name: Comment PR with cfn-lint Results
        if: always() && steps.findPr.outputs.pr != '' && steps.cfn-lint.outputs.has_results == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const cfnLintOutput = fs.readFileSync('${{ steps.cfn-dir.outputs.dir }}/cfn-lint-results.txt', 'utf8');

            // Truncate if too long
            let output = cfnLintOutput;
            if (output.length > 60000) {
              output = output.substring(0, 60000) + '\n\n... (output truncated)';
            }

            const body = `## CloudFormation Linter Results

            <details><summary>View cfn-lint Findings</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            **Commit:** ${{ github.sha }}`;

            github.rest.issues.createComment({
              issue_number: ${{ steps.findPr.outputs.pr }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Terraform directory
        id: terraform-dir
        run: |
          if [ -n "${{ inputs.terraform-directory }}" ]; then
            echo "dir=${{ inputs.terraform-directory }}" >> $GITHUB_OUTPUT
          else
            echo "dir=${{ inputs.working-directory }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for Terraform files
        id: check-tf
        run: |
          if find "${{ steps.terraform-dir.outputs.dir }}" -type f -name "*.tf" | grep -q .; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Terraform
        if: steps.check-tf.outputs.has_terraform == 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt check
        if: steps.check-tf.outputs.has_terraform == 'true'
        working-directory: ${{ steps.terraform-dir.outputs.dir }}
        run: terraform fmt -check -recursive || true

      - name: Terraform init
        if: steps.check-tf.outputs.has_terraform == 'true'
        working-directory: ${{ steps.terraform-dir.outputs.dir }}
        run: terraform init -backend=false

      - name: Terraform validate
        if: steps.check-tf.outputs.has_terraform == 'true'
        working-directory: ${{ steps.terraform-dir.outputs.dir }}
        run: terraform validate
